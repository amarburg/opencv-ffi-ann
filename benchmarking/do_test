#!/usr/bin/env ruby

$LOAD_PATH << Pathname.new(__FILE__).parent.join("lib")

require 'flann_experiment'
require 'perturb_homography'

def motueka_four( file )
  Pathname.new( "~/workspace/aerial_data_sets/motueka_quarter_scale/four" ).join(file).expand_path
end

exp = FlannExperiment.from_opts { |exp|

  a = exp.image_pairs.add( motueka_four( "IMG_7654.jpg" ), motueka_four("IMG_7655.jpg"),
                      h:  [[ 1.01912e+00, -1.53479e-02, -5.10015e+01 ],  
                           [2.72249e-03,  9.98174e-01, -1.26761e+02 ], 
                           [3.09099e-05, -5.04486e-05,  1.00000e+00 ]]  )

  perturbed_h = PerturbHomography.new( a.homography, "one",
                                         roll_var: 0.000001,
                                         pitch_var: 0.00,
                                         yaw_var: 0.00 )
  exp.image_pairs.add_pair ImagePairPerturbed.new( a, h: perturbed_h )

  exp.algorithms << (exp.reference = BruteForceMatcher.new)
  exp.algorithms << ManualGeometry.new
#  exp.algorithms << L2SqrBruteForceMatcher.new
#  exp.algorithms << CVFFIBruteForceMatcher.new
#  exp.algorithms << CVFFIFlannMatcher.new
  exp.algorithms << FlannMatcher.new
  exp.algorithms << KMeansFlannMatcher.new

  weight = 10e2
  prescale = 1.0/ (972*972)
  exp.algorithms << EnhancedCVFFIFlannMatcher.new( weight, prescaler: prescale  )
  exp.algorithms << EnhancedFlannMatcher.new( weight, prescaler: prescale )

}

exp.dump
results = exp.run


